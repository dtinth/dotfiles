#!/bin/bash
set -eo pipefail
ARCH=$(uname -m)

if test -e /opt/homebrew/bin
then
  PATH=/opt/homebrew/bin:$PATH
fi

main() {
  ensure  check_mise       install_mise
  ensure  check_fish       install_fish
  install_enqueued_apt_packages
  recheck_commands

  install_mise_tools
  recheck_commands
  
  ensure  check_fisher     install_fisher
  ensure  check_fish_git   install_fish_git
  recheck_commands

  setup_git_config
  setup_tmux_config
}

check_mise() {
  command_exists mise
}
install_mise() {
  if command_exists brew; then
    brew install mise
  elif command_exists apt-get; then
    install_apt_package curl
    curl https://mise.run | bash
  elif command_exists pkg; then
    pkg install mise -y
  else
    curl https://mise.run | bash
  fi
  export PATH="$HOME/.local/bin:$HOME/.local/share/mise/shims:$PATH"
}

check_starship() {
  command_exists starship
}
install_starship_mise() {
  mise use -g starship
  mise reshim
}

check_fzf() {
  command_exists fzf
}
install_fzf_mise() {
  mise use -g fzf
  mise reshim
}

check_gh() {
  command_exists gh
}
install_gh_mise() {
  mise use -g github-cli
  mise reshim
}

check_bat() {
  command_exists bat
}
install_bat_mise() {
  mise use -g bat
  mise reshim
}

install_mise_tools() {
  ensure check_starship install_starship_mise
  ensure check_fzf install_fzf_mise
  ensure check_gh install_gh_mise
  ensure check_bat install_bat_mise
}

check_fish() {
  command_exists fish
}
install_fish() {
  if command_exists brew; then
    brew install fish
  elif command_exists apt-get; then
    install_apt_package fish
  fi
}

check_fisher() {
  test -f ~/.config/fish/functions/fisher.fish
}
install_fisher() {
  fish -c 'curl -sL https://git.io/fisher | source && fisher install jorgebucaran/fisher'
}





check_fish_git() {
  test -f ~/.config/fish/conf.d/git.fish
}
install_fish_git() {
  fish -c 'fisher install jhillyerd/plugin-git'
}





setup_git_config() {
  # Only allow fast-forwards when pulling.
  git config --global pull.ff only
}
setup_tmux_config() {
  # Load ~/dotfiles/tmux/tmux.conf
  if [ ! -f ~/.tmux.conf ] || ! grep -q 'source-file ~/dotfiles/tmux/tmux.conf' ~/.tmux.conf; then
    echo 'source-file ~/dotfiles/tmux/tmux.conf' >> ~/.tmux.conf
  fi
}

commands_to_recheck=()
ensure() {
  if ! "$1"; then
    echo >&2 "=> $1 failed, running $2..."
    "$2"
  fi
  commands_to_recheck+=("$1")
}
recheck_commands() {
  for command in "${commands_to_recheck[@]}"; do
    if ! "$command"; then
      echo >&2 "=> $command failed, exiting..."
      exit 1
    fi
  done
  commands_to_recheck=()
}

command_exists() {
  command -v "$1" >/dev/null 2>&1
}

apt_packages_to_install=()
apt_updated=
install_apt_package() {
  if [ -z "$apt_updated" ]; then
    sudo apt-get update || true
    apt_updated=1
  fi
  apt_packages_to_install+=("$1")
}
install_enqueued_apt_packages() {
  if [ "${#apt_packages_to_install[@]}" -gt 0 ]; then
    sudo apt-get install -y "${apt_packages_to_install[@]}"
    apt_packages_to_install=()
  fi
}

main
